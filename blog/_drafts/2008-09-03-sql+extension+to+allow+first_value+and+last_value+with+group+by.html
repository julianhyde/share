---
layout: post
title: SQL extension to allow FIRST_VALUE and LAST_VALUE with GROUP BY
date: '2008-09-03T17:14:00.000-07:00'
author: Julian Hyde
tags: 
modified_time: '2008-09-03T17:22:15.084-07:00'
blogger_id: tag:blogger.com,1999:blog-5672165237896126100.post-6911986551028487637
---

At SQLstream, we have come across an interesting query pattern that seems to be difficult to express in standard SQL (SQL:2003 or SQL:2008). It turns out to be applicable to regular SQL as well as streaming SQL, and therefore<br /><br />First some background, for those of you who don't fall asleep every night reading the SQL standard. There are two kinds of aggregation in standard SQL: windowed aggregation, of the form<br /><function><blockquote><span style="font-family: courier new;"><function>(<arg></span><arg><span style="font-family: courier new;"> {, <arg></span><arg><span style="font-family: courier new;">}) over <window specification></span><window></window></arg></arg></blockquote><arg><arg><window>and grouped aggregation, which is of the form<br /><function><blockquote><function>(<arg><arg> {, <arg><arg>})</arg></arg></blockquote><arg><arg>and requires a GROUP BY clause. (If the GROUP BY clause is not present, 'GROUP BY ()' is assumed.)<br /><br />According to the standard, these two forms should never meet. It is illegal to use a windowed aggregation in a SELECT that has a GROUP BY, or to mix grouped aggregation and windowed aggregation in the same SELECT. (It's OK to use one in a sub-query and another in an enclosing query.)<br /><br />However, here is a very reasonable query that is difficult to express in standard SQL: Given a record of every trade on a stock exchange, give me the volume and closing price of each ticker symbol. You might try<br /><br /><blockquote>SELECT<br />   day,<br />   ticker,<br />   SUM(shares) AS volume,<br />      LAST_VALUE(price) AS closingPrice<br />FROM Trades<br />GROUP BY day, ticker</blockquote><br /><br />but this is illegal SQL. Why is it illegal? Because the LAST_VALUE function (like FIRST_VALUE and RANK) is a windowed aggregate function and is only meaningful on an ordered set.<br /><br />To introduce the notion of ordering, I propose that the following query should be valid:<br /><br /><blockquote>SELECT<br /> day,<br /> ticker,<br /> SUM(shares) AS volume,<br /> LAST_VALUE(price) OVER (ORDER BY timeOfDay) AS closingPrice<br />FROM Trades<br />GROUP BY day, ticker</blockquote><br /><br />With the OVER clause, LAST_VALUE is now a windowed aggregate function within the context of a GROUP BY query, which was previously illegal. Every windowed aggregate is applied to a window, so what is the window in this case? We want the window to contain all of the rows with the same day and ticker value, and to be sorted by timeOfDay. In other words, the window inherits the GROUP BY columns as its implicit PARTITION BY clause. It is as if they had written<br /><br />LAST_VALUE(price) OVER (PARTITION BY day, ticker ORDER BY timeOfDay)<br /><br />Now, if you know that I work for SQLstream, you will guess that I am motivated to make this work for streaming queries. A streaming aggregation query over the Trades stream would look like this:<br /><br />SELECT STREAM<br /> day,<br /> ticker,<br /> SUM(shares) AS volume,<br /> LAST_VALUE(price) OVER (ORDER BY timeOfDay) AS closingPrice<br />FROM Trades<br />GROUP BY day, ticker<br /><br />In idiomatic SQLstream SQL, we would typically express the query slightly more tersely:<br /><br />SELECT STREAM<br /> FLOOR(t.ROWTIME TO DAY),<br /> ticker,<br /> SUM(shares) AS volume,<br /> LAST_VALUE(price) OVER () AS closingPrice<br />FROM Trades<br />GROUP BY FLOOR(t.ROWTIME TO DAY), ticker<br /><br />This uses SQLstream's system ROWTIME column and the 'FLOOR(&lt;datetime expression&gt; TO &lt;time unit&gt;)' operator, and so can dispense with the day and timeOfDay columns. Also, streams are ordered by ROWTIME by default, so we can abbreviate 'OVER (ORDER BY ROWTIME)' to 'OVER ()'.<br /><br />The end result is powerful and, I think, consistent with the spirit of standard SQL.</arg></arg></function></window></arg></arg></function>